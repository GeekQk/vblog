#  vblog项目重构 v2


## v1的问题

v1: 
+ UserServiceImp
+ TokenServiceImpl
+ TokenApiHandler

```go
package main

import (
	"github.com/gin-gonic/gin"
	"gitlab.com/go-course-project/go13/vblog/apps/token/api"
	token_impl "gitlab.com/go-course-project/go13/vblog/apps/token/impl"
	user_impl "gitlab.com/go-course-project/go13/vblog/apps/user/impl"
)


func main() {
	// user service impl
	usvc := user_impl.NewUserServiceImpl()

	// token service impl
	tsvc := token_impl.NewTokenServiceImpl(usvc)

	// api
	TokenApiHander := api.NewTokenApiHandler(tsvc)

	// Protocol
	engine := gin.Default()

	rr := engine.Group("/vblog/api/v1")
	TokenApiHander.Registry(rr)

	// 把Http协议服务器启动起来
	if err := engine.Run(":8080"); err != nil {
		panic(err)
	}
}
```

当模块众多的时候, main里面 手动组装对象的难度很越来越大

## ioc: 依赖反转

控制反转（Inversion of Control，缩写为IoC）

[](./docs/ioc.drawio)


```go
1. 注册对象(采用 init()导入的方式来执行注册)

_ "gitlab.com/go-course-project/go13/vblog/apps/token/api"
_ "gitlab.com/go-course-project/go13/vblog/apps/token/impl"
_ "gitlab.com/go-course-project/go13/vblog/apps/user/impl"

ioc.Registry("user_service_impl", &UserServiceImpl{})
ioc.Registry("token_service_impl", &TokenServiceImpl{})

2. 没有依赖关系的管理, 每个对象自己去ioc获取自己依赖
// 怎么实现token.Service接口?
// 定义TokenServiceImpl来实现接口
type TokenServiceImpl struct {
	// 依赖了一个数据库操作的链接池对象
	db *gorm.DB

	// 依赖user.Service, 没有 UserServiceImpl 具体实现
	// 依赖接口，不要接口的具体实现
	user user.Service
}

// 依赖的关系解决 分层2个阶段, 一个注册, 一个初始化(组件完善自己的依赖关系)
func (i *TokenServiceImpl) Init() {
    // 先通过ioc获取对象, 然后再把对象断言成 你需要接口
    // 	tsvc := token_impl.NewTokenServiceImpl(usvc) 都不要
    i.user = ioc.Get("user_service_impl").(user.Service)
}

3. ioc 来完成的对象的初始化, 让每个注册的对象，去完成依赖的自主寻找
ioc.InitAllObject()
```


4. 没写一个对象 就注册一个对象, 参考mcenter的具体做法
```go
package apps

import (
	// 注册所有内部服务模块, 无须对外暴露的服务, 用于内部依赖
	_ "github.com/infraboard/mcenter/apps/counter/impl"
	_ "github.com/infraboard/mcenter/apps/ip2region/impl"

	// 引入第三方存储模块(Mongo)
	_ "github.com/infraboard/mcube/v2/ioc/apps/oss/mongo"

	// 注册所有GRPC服务模块, 暴露给框架GRPC服务器加载, 注意 导入有先后顺序
	_ "github.com/infraboard/mcenter/apps/domain/impl"
	_ "github.com/infraboard/mcenter/apps/endpoint/impl"
	_ "github.com/infraboard/mcenter/apps/instance/impl"
	_ "github.com/infraboard/mcenter/apps/label/impl"
	_ "github.com/infraboard/mcenter/apps/namespace/impl"
	_ "github.com/infraboard/mcenter/apps/notify/impl"
	_ "github.com/infraboard/mcenter/apps/policy/impl"
	_ "github.com/infraboard/mcenter/apps/resource/impl"
	_ "github.com/infraboard/mcenter/apps/role/impl"
	_ "github.com/infraboard/mcenter/apps/service/impl"
	_ "github.com/infraboard/mcenter/apps/token/impl"
	_ "github.com/infraboard/mcenter/apps/user/impl"
)
```

## ioc 具体实现

使用map[string]Object 来实现一个简易版本的ioc




